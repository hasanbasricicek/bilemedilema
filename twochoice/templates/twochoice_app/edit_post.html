{% extends 'twochoice_app/base.html' %}

{% block title %}Gönderiyi Düzenle - bilemedilema{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-2xl border border-[#BFBFBF] shadow-sm p-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-[#000000] mb-2">Gönderiyi Düzenle</h2>
            <p class="text-[#666A73]">Düzenleme sonrası gönderin tekrar moderatör onayına gönderilecek.</p>
        </div>

        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <div>
                <label class="block text-sm font-medium text-[#000000] mb-2">
                    {{ form.title.label }}
                </label>
                {{ form.title }}
                {% if form.title.errors %}
                    <p class="mt-1 text-sm text-[#B33F00]">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-[#000000] mb-2">
                    {{ form.content.label }}
                </label>
                {{ form.content }}
                {% if form.content.errors %}
                    <p class="mt-1 text-sm text-[#B33F00]">{{ form.content.errors.0 }}</p>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-[#000000] mb-2">
                    {{ form.post_type.label }}
                </label>
                {{ form.post_type }}
                {% if form.post_type.errors %}
                    <p class="mt-1 text-sm text-[#B33F00]">{{ form.post_type.errors.0 }}</p>
                {% endif %}
            </div>

            <div id="poll-options-container" class="{% if post.post_type == 'comment_only' %}hidden{% endif %}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_option_1.label }}
                        </label>
                        {{ form.poll_option_1 }}
                        {% if form.poll_option_1.errors %}
                            <p class="mt-1 text-sm text-[#B33F00]">{{ form.poll_option_1.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_option_2.label }}
                        </label>
                        {{ form.poll_option_2 }}
                        {% if form.poll_option_2.errors %}
                            <p class="mt-1 text-sm text-[#B33F00]">{{ form.poll_option_2.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_option_3.label }}
                        </label>
                        <div id="poll-opt-3">{{ form.poll_option_3 }}</div>
                        {% if form.poll_option_3.errors %}
                            <p class="mt-1 text-sm text-[#B33F00]">{{ form.poll_option_3.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_option_4.label }}
                        </label>
                        <div id="poll-opt-4">{{ form.poll_option_4 }}</div>
                        {% if form.poll_option_4.errors %}
                            <p class="mt-1 text-sm text-[#B33F00]">{{ form.poll_option_4.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-end gap-2 pt-1">
                        <button type="button" id="btn-remove-opt" class="px-3 py-2 rounded-xl text-sm border border-[#BFBFBF] bg-white text-[#000000] hover:bg-[#F8F9F6] transition duration-200">Şık kaldır</button>
                        <button type="button" id="btn-add-opt" class="px-3 py-2 rounded-xl text-sm bg-[#000000] text-white font-semibold hover:bg-[#666A73] transition duration-200">Şık ekle</button>
                    </div>

                    <div class="flex items-center pt-2">
                        {{ form.allow_multiple_choices }}
                        <label class="ml-2 text-sm text-[#000000]">
                            {{ form.allow_multiple_choices.label }}
                        </label>
                    </div>

                    <div class="pt-2">
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_close_mode.label }}
                        </label>
                        {{ form.poll_close_mode }}
                    </div>

                    <div class="pt-2 {% if form.poll_close_mode.value != 'manual' %}hidden{% endif %}" id="poll-close-at-wrapper">
                        <label class="block text-sm font-medium text-[#000000] mb-2">
                            {{ form.poll_closes_at.label }}
                        </label>
                        {{ form.poll_closes_at }}
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between pt-6 border-t border-[#BFBFBF]">
                <a href="{% url 'post_detail' post.pk %}" class="text-[#666A73] hover:text-[#000000] font-semibold transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>İptal
                </a>
                <button type="submit" class="bg-[#000000] hover:bg-[#666A73] text-white font-semibold px-6 py-3 rounded-xl transition duration-200 flex items-center space-x-2">
                    <i class="fas fa-save"></i>
                    <span>Kaydet</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const postTypeSelect = document.getElementById('id_post_type');
    const pollOptionsContainer = document.getElementById('poll-options-container');
    const closeModeSelect = document.getElementById('id_poll_close_mode');
    const closeAtWrapper = document.getElementById('poll-close-at-wrapper');
    const btnAddOpt = document.getElementById('btn-add-opt');
    const btnRemoveOpt = document.getElementById('btn-remove-opt');

    function syncCloseAt() {
        if (!closeModeSelect || !closeAtWrapper) return;
        if (closeModeSelect.value === 'manual') {
            closeAtWrapper.classList.remove('hidden');
        } else {
            closeAtWrapper.classList.add('hidden');
        }
    }

    postTypeSelect.addEventListener('change', function() {
        if (this.value === 'poll_only' || this.value === 'both') {
            pollOptionsContainer.classList.remove('hidden');
        } else {
            pollOptionsContainer.classList.add('hidden');
        }
        syncCloseAt();
    });

    if (closeModeSelect) {
        closeModeSelect.addEventListener('change', syncCloseAt);
    }

    function addOption() {
        const i3 = document.getElementById('id_poll_option_3');
        const i4 = document.getElementById('id_poll_option_4');
        if (i3 && i3.parentElement.classList.contains('hidden')) {
            i3.parentElement.classList.remove('hidden');
            i3.focus();
            return;
        }
        if (i4 && i4.parentElement.classList.contains('hidden')) {
            i4.parentElement.classList.remove('hidden');
            i4.focus();
            return;
        }
    }

    function removeOption() {
        const i4 = document.getElementById('id_poll_option_4');
        const i3 = document.getElementById('id_poll_option_3');
        if (i4 && !i4.parentElement.classList.contains('hidden')) {
            i4.value = '';
            i4.parentElement.classList.add('hidden');
            return;
        }
        if (i3 && !i3.parentElement.classList.contains('hidden')) {
            i3.value = '';
            i3.parentElement.classList.add('hidden');
        }
    }

    if (btnAddOpt) btnAddOpt.addEventListener('click', addOption);
    if (btnRemoveOpt) btnRemoveOpt.addEventListener('click', removeOption);

    try {
        const i3 = document.getElementById('id_poll_option_3');
        const i4 = document.getElementById('id_poll_option_4');
        if (i3 && !i3.value.trim()) i3.parentElement.classList.add('hidden');
        if (i4 && !i4.value.trim()) i4.parentElement.classList.add('hidden');
    } catch (e) {}

    syncCloseAt();
</script>
{% endblock %}
